name: Debug Build

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  debug:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: external
          key: deps-${{ hashFiles('Makefile') }}

      - name: Download dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: make deps

      - name: Restore APT Cache
        id: cache-apt-restore
        uses: actions/cache/restore@v3
        with:
          path: /var/cache/apt/archives/
          key: apt-cache

      - name: Install tools
        run: sudo apt install -y gcc-arm-none-eabi libnewlib-arm-none-eabi ninja-build

      - name: Save APT Cache
        id: cache-apt-save
        uses: actions/cache/save@v3
        with:
          path: /var/cache/apt/archives/
          key: ${{ steps.cache-apt-restore.outputs.cache-primary-key }}

      - name: Build
        run: make release
